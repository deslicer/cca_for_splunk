---
# tasks file for cca.common.setup-wizard
#
# Description:
#
# Prerequisite:
#
# Author: Andr√© Enemark
#
# Release: 2022.2.4

- ansible.builtin.set_fact:
    current_item:
      key: "{{ item.key }}"
      value: "{{ item.value }}"
  with_dict:
    - "{{ secret_type }}"

- name: Generate a random password for pass4SymmKey
  ansible.builtin.shell:
    cmd: "{{ splunk_path }}/bin/splunk cmd openssl rand -base64 48"
  register: random_pass4SymmKey

- ansible.builtin.set_fact:
    tmp_key: "{{ current_item.key }}_{{ current_item.value}}"

- ansible.builtin.set_fact:
    tmp_password: "{{ vars_current_wizard[tmp_key] if cca_identical == true else random_pass4SymmKey.stdout }}"

- name: Password for {{ current_item.key }}
  ansible.builtin.pause:
    prompt: "Press enter for a random password or enter a 8 character minimum password for {{ secret_type }} ({{tmp_password}})"
  register: password_prompt
  when: not current_item.key | regex_search('default')

- ansible.builtin.set_fact:
    secret_password: "{{ tmp_password if password_prompt.user_input | length == 0 else password_prompt.user_input }}"
  when: not current_item.key | regex_search('default')

- ansible.builtin.set_fact:
    secret_password: 'password'
  when: current_item.key | regex_search('default')

- name: Encrypt the password
  ansible.builtin.shell:
    cmd: "{{ splunk_path }}/bin/splunk show-encrypted --value '{{ secret_password }}'"
  register: encrypted_random_secret

- name: Assert that the splunk show password command was successful
  ansible.builtin.assert:
    that:
      - encrypted_random_secret.stderr == ''

- name: Vault the secret password
  ansible.builtin.shell:
    cmd: "ansible-vault encrypt_string '{{ secret_password }}' | {{ sed_cmd }} ':a; N; $!ba; s/\\n/#/g' | {{ sed_cmd }} 's/[[:space:]]*//g' | {{ sed_cmd }} 's/|#/ \"/' | {{ sed_cmd }} 's/$/\"/'"
  register: vault_secret_result

- name: Save the clear text secret as an ansible vault
  ansible.builtin.lineinfile:
    path: "{{ vars.cca_splunk_secret_file }}"
    line: "{{ current_item.key }}_{{ current_item.value}}: {{ vault_secret_result.stdout | replace('#','\\r\\n') }}"
    regex: '^{{ current_item.key }}_{{ current_item.value}}:'

- name: Save the hashed secret to the file
  ansible.builtin.lineinfile:
    path: "{{ vars.cca_splunk_secret_file }}"
    line: "{{ current_item.key }}_{{ current_item.value}}_hash: '{{ encrypted_random_secret.stdout }}'"
    regex: '^{{ current_item.key }}_{{ current_item.value}}_hash:'
